# (A) ìœ ì €/ë¡¤ë§Œ
kubectl -n $DB_NS exec -i "$PG_POD" -- bash -lc 'pg_dumpall -U postgres --globals-only' > pg_globals.sql

# (B) ê° DB ë°ì´í„°
kubectl -n $DB_NS exec -i "$PG_POD" -- pg_dump -U orders      orders      > orders.sql
kubectl -n $DB_NS exec -i "$PG_POD" -- pg_dump -U inventory   inventory   > inventory.sql
kubectl -n $DB_NS exec -i "$PG_POD" -- pg_dump -U fulfillment fulfillment > fulfillment.sql


export KAFKA_NS=<kafka-namespace>
export KFK_POD=$(kubectl -n $KAFKA_NS get po -l app.kubernetes.io/name=kafka -o jsonpath='{.items[0].metadata.name}')

# ì „ì²´ í† í”½ ëª©ë¡ ë°±ì—…
kubectl -n $KAFKA_NS exec -i "$KFK_POD" -- \
  kafka-topics.sh --bootstrap-server localhost:9092 --list \
  > kafka_topics.list

# ê° í† í”½ ì„¤ì •/íŒŒí‹°ì…˜ ì„¤ëª… ë°±ì—…
for t in orders.v1.created orders.v1.inventory_reserved orders.v1.inventory_rejected; do
  kubectl -n $KAFKA_NS exec -i "$KFK_POD" -- \
    kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic "$t" \
    > "topic_${t}.desc"
done


export GCP_PROJECT=rare-botany-470713-p9
export ZONE=asia-northeast3-a
export STD_CLUSTER=std-workshop-eda

gcloud config set project "$GCP_PROJECT"
gcloud container clusters create "$STD_CLUSTER" \
  --zone "$ZONE" \
  --machine-type=e2-standard-2 \
  --disk-type=pd-standard \
  --disk-size=50 \
  --enable-ip-alias


gcloud container clusters get-credentials "$STD_CLUSTER" --zone "$ZONE"


helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

# release ì´ë¦„: postgres  â†’ ì„œë¹„ìŠ¤ DNS: postgres-postgresql.$DB_NS.svc.cluster.local
helm upgrade --install postgres bitnami/postgresql \
  -n $NS \
  --set auth.postgresPassword=postgrespw \
  --set primary.persistence.size=8Gi \
  --wait

# í¬ë“œ ì´ë¦„
export PG_POD=$(kubectl -n $NS get po -l app.kubernetes.io/name=postgresql -o jsonpath='{.items[0].metadata.name}')



# orders, inventory, fulfillment DB & ìœ ì € ìƒì„±/ë¹„ë²ˆ ì„¤ì •
kubectl -n $NS exec -i "$PG_POD" -- \
bash -lc 'export PGPASSWORD=postgrespw'; \
psql -U postgres -h 127.0.0.1 -p 5432  <<SQL
DO \$\$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '\''orders'\'') THEN
    CREATE USER orders WITH PASSWORD '\''orderspw'\'';
  ELSE
    ALTER USER orders WITH PASSWORD '\''orderspw'\'';
  END IF;
  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '\''inventory'\'') THEN
    CREATE USER inventory WITH PASSWORD '\''invpw'\'';
  ELSE
    ALTER USER inventory WITH PASSWORD '\''invpw'\'';
  END IF;
  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '\''fulfillment'\'') THEN
    CREATE USER fulfillment WITH PASSWORD '\''fulpw'\'';
  ELSE
    ALTER USER fulfillment WITH PASSWORD '\''fulpw'\'';
  END IF;
  IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '\''orders'\'') THEN
    CREATE DATABASE orders OWNER orders;
  END IF;
  IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '\''inventory'\'') THEN
    CREATE DATABASE inventory OWNER inventory;
  END IF;
  IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '\''fulfillment'\'') THEN
    CREATE DATABASE fulfillment OWNER fulfillment;
  END IF;
END
\$\$;
SQL


# ë¡œì»¬ì˜ init SQL 3ê°œë¥¼ í¬ë“œë¡œ ë³µì‚¬ (ê²½ë¡œëŠ” ë„¤ ë ˆí¬ êµ¬ì¡°ì— ë§ì¶° ìˆ˜ì •)
kubectl -n $DB_NS cp infra/sql/order-init.sql       "$PG_POD":/tmp/order-init.sql
kubectl -n $DB_NS cp infra/sql/inventory-init.sql   "$PG_POD":/tmp/inventory-init.sql
kubectl -n $DB_NS cp infra/sql/fulfillment-init.sql "$PG_POD":/tmp/fulfillment-init.sql

# ì ìš©
kubectl -n $DB_NS exec -it "$PG_POD" -- bash -lc '
  export PGPASSWORD="$POSTGRES_PASSWORD";
  psql -U orders      -d orders      -f /tmp/order-init.sql
  psql -U inventory   -d inventory   -f /tmp/inventory-init.sql
  psql -U fulfillment -d fulfillment -f /tmp/fulfillment-init.sql
'


helm upgrade --install kafka bitnami/kafka \
  -n $NS \
  --set kraft.enabled=true \
  --set controller.replicaCount=1 \
  --set broker.replicaCount=1 \
  --set listeners.client.protocol=PLAINTEXT \
  --set advertisedListeners.client="PLAINTEXT://kafka.$NS.svc.cluster.local:9092" \
  --set persistence.size=10Gi \
  --wait

export KFK_POD=$(kubectl -n $NS get po -l app.kubernetes.io/name=kafka -o jsonpath='{.items[0].metadata.name}')


for t in dlq.fulfillment dlq.inventory dlq.orders orders.v1.canceled orders.v1.completed orders.v1.created orders.v1.fulfillment_scheduled orders.v1.inventory_rejected orders.v1.inventory_reserved orders.v1.payment_authorized orders.v1.payment_failed; do
  kubectl -n $NS exec -i "$KFK_POD" -- \
    kafka-topics.sh --bootstrap-server localhost:9092 \
      --create --if-not-exists --topic "$t" \
      --partitions 3 --replication-factor 1
done




gcloud container node-pools create highcpu-pool \
  --cluster=std-workshop-eda \
  --zone=$ZONE \
  --machine-type=e2-standard-2 \
  --num-nodes=2 \
  --enable-autoscaling --min-nodes=1 --max-nodes=3


kubectl exec -it kafka-broker-0 -n $NS -- \
  kafka-consumer-groups.sh \
  --bootstrap-server kafka-broker-0:9092 \
  --describe 


START_TS=$(date +%s%3N)
curl --location -k --request POST "https://demo-instana.automation.ibmce-kr.com/api/releases" \
--header "Authorization: apiToken 5Ucf5mstQkism3ZU699CKA" \
--header "Content-Type: application/json" \
--data "{ \"name\": \"test\", \"start\": \"17567717953\", \"applications\": [{ \"name\": \"TXC LG Hands-On\" }]}"

curl --location -k --request POST "https://demo-instana.automation.ibmce-kr.com/api/releases" \
--header "Authorization: apiToken 5Ucf5mstQkism3ZU699CKA" \
--header "Content-Type: application/json" \
--data "{ \"name\": \"test\", \"start\": \"1756788578535\", \"applications\": [{ \"name\": \"TXC LG Hands-On\" }]}"



# Order Service â€“ Minimal Web UI (GKEâ€‘ready)

This repo gives you a tiny static web page to:

* Look up an order by ID (GET /orders/{id})
* Create/send an order (POST /orders)
* Trigger JavaScript errors on demand (for EUM tests)

Itâ€™s optimized for **simple deployment to GKE** using NGINX, with a **runtime-configurable base URL** (no rebuild needed) via `config.js` mounted from a ConfigMap.

---

## ğŸ“ Files

### 1) `index.html`

```html
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Service Tester</title>
  <!-- Tailwind via CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Config (overridden by config.js when present) -->
  <script>
    window.__CONFIG__ = {
      BASE_URL: "/api" // default; overridden by /config.js in k8s
    };
  </script>
  <!-- Optional: your EUM script could be injected here -->
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Order Service Tester</h1>
      <p class="text-sm text-slate-500">ê°„ë‹¨í•œ ì£¼ë¬¸ API í…ŒìŠ¤íŠ¸ ë° JS ì˜¤ë¥˜ ìœ ë„ í™”ë©´</p>
    </header>

    <!-- Base URL Panel -->
    <section class="mb-6 p-4 bg-white rounded-2xl shadow">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end">
        <label class="flex-1">
          <span class="block text-sm font-medium">API Base URL</span>
          <input id="baseUrl" class="mt-1 w-full rounded-xl border p-2" placeholder="https://your-order-api.example.com" />
        </label>
        <button id="applyBaseUrl" class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700">ì ìš©</button>
        <button id="pingBtn" class="rounded-xl px-4 py-2 border">/health ì²´í¬</button>
      </div>
      <p class="mt-2 text-xs text-slate-500">ê¸°ë³¸ê°’ì€ <code>window.__CONFIG__.BASE_URL</code> ì…ë‹ˆë‹¤. GKEì—ì„  ConfigMapìœ¼ë¡œ ì£¼ì…ë˜ëŠ” <code>/config.js</code>ê°€ ì´ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.</p>
    </section>

    <div class="grid gap-6 md:grid-cols-2">
      <!-- Order Lookup -->
      <section class="p-4 bg-white rounded-2xl shadow">
        <h2 class="text-lg font-semibold mb-3">ì£¼ë¬¸ ì¡°íšŒ (GET /orders/{id})</h2>
        <div class="flex gap-2">
          <input id="orderId" class="flex-1 rounded-xl border p-2" placeholder="ì£¼ë¬¸ ID ì…ë ¥" />
          <button id="lookupBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white hover:bg-blue-700">ì¡°íšŒ</button>
        </div>
      </section>

      <!-- Send Order -->
      <section class="p-4 bg-white rounded-2xl shadow">
        <h2 class="text-lg font-semibold mb-3">ì£¼ë¬¸ ìƒì„± (POST /orders)</h2>
        <textarea id="orderBody" class="w-full h-40 rounded-xl border p-2 font-mono text-sm">{
  "orderId": "o-{{timestamp}}",
  "userId": "u-123",
  "items": [
    { "sku": "SKU-100", "qty": 1, "price": 12000 },
    { "sku": "SKU-200", "qty": 2, "price": 3400 }
  ],
  "currency": "KRW",
  "note": "web ui test"
}</textarea>
        <div class="mt-2 flex gap-2">
          <button id="sendBtn" class="rounded-xl px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700">ì „ì†¡</button>
          <button id="formatBtn" class="rounded-xl px-4 py-2 border">JSON ì •ë ¬</button>
        </div>
      </section>
    </div>

    <!-- JS Error Triggers -->
    <section class="mt-6 p-4 bg-white rounded-2xl shadow">
      <h2 class="text-lg font-semibold mb-3">JS ì—ëŸ¬ ë°œìƒ</h2>
      <div class="flex flex-wrap gap-2">
        <button id="throwBtn" class="rounded-xl px-4 py-2 bg-rose-600 text-white hover:bg-rose-700">Unhandled Error throw()</button>
        <button id="promiseBtn" class="rounded-xl px-4 py-2 bg-amber-500 text-white hover:bg-amber-600">Unhandled Promise Rejection</button>
        <button id="handledBtn" class="rounded-xl px-4 py-2 border">Handled Error (try/catch)</button>
      </div>
      <p class="mt-2 text-xs text-slate-500">Instana EUM ë“± JS ì—ëŸ¬ ìˆ˜ì§‘ ë„êµ¬ í…ŒìŠ¤íŠ¸ìš©</p>
    </section>

    <!-- Output Panel -->
    <section class="mt-6 p-4 bg-white rounded-2xl shadow">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">ì‘ë‹µ / ë¡œê·¸</h2>
        <div class="flex gap-2">
          <button id="clearBtn" class="rounded-xl px-3 py-1 border text-sm">Clear</button>
          <label class="text-sm text-slate-500 flex items-center gap-1"><input id="tsToggle" type="checkbox" class="mr-1" checked>íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ</label>
        </div>
      </div>
      <pre id="output" class="bg-slate-900 text-slate-100 rounded-xl p-3 text-xs overflow-auto max-h-72"></pre>
    </section>
  </div>

  <script>
    // --- Utilities ---
    const $ = (sel) => document.querySelector(sel);
    const out = $('#output');
    const ts = () => new Date().toISOString();
    const log = (level, obj) => {
      const showTs = $('#tsToggle').checked;
      const prefix = showTs ? `[${ts()}] ${level}` : level;
      out.textContent += `${prefix} Â» ${typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)}\n`;
      out.scrollTop = out.scrollHeight;
    };

    // --- Config ---
    let BASE_URL = (window.__CONFIG__ && window.__CONFIG__.BASE_URL) || '/api';
    const baseUrlInput = $('#baseUrl');
    baseUrlInput.value = BASE_URL;

    $('#applyBaseUrl').addEventListener('click', () => {
      BASE_URL = baseUrlInput.value.trim() || BASE_URL;
      log('info', `BASE_URL set to ${BASE_URL}`);
    });

    $('#pingBtn').addEventListener('click', async () => {
      try {
        const res = await fetch(`${BASE_URL}/health`);
        const text = await res.text();
        log('ok', { status: res.status, body: text });
      } catch (e) {
        log('error', e.message || e);
      }
    });

    // --- Lookup ---
    $('#lookupBtn').addEventListener('click', async () => {
      const id = $('#orderId').value.trim();
      if (!id) return log('warn', 'orderId í•„ìš”');
      try {
        const res = await fetch(`${BASE_URL}/orders/${encodeURIComponent(id)}`);
        const body = await res.json().catch(() => ({ raw: 'non-json', text: res.statusText }));
        log(res.ok ? 'ok' : 'fail', { status: res.status, body });
      } catch (e) {
        log('error', e.message || e);
      }
    });

    // --- Send Order ---
    const templateReplace = (s) => s.replaceAll('{{timestamp}}', Date.now());
    $('#formatBtn').addEventListener('click', () => {
      try {
        const raw = templateReplace($('#orderBody').value);
        const obj = JSON.parse(raw);
        $('#orderBody').value = JSON.stringify(obj, null, 2);
      } catch (e) {
        log('warn', 'ìœ íš¨í•œ JSONì´ ì•„ë‹™ë‹ˆë‹¤. {{timestamp}} ëŠ” ìˆ«ìë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤.');
      }
    });

    $('#sendBtn').addEventListener('click', async () => {
      try {
        const raw = templateReplace($('#orderBody').value);
        const obj = JSON.parse(raw);
        const res = await fetch(`${BASE_URL}/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        });
        const body = await res.json().catch(() => ({ raw: 'non-json' }));
        log(res.ok ? 'ok' : 'fail', { status: res.status, body });
      } catch (e) {
        log('error', e.message || e);
      }
    });

    // --- Error Buttons ---
    $('#throwBtn').addEventListener('click', () => {
      throw new Error('Intentional unhandled error from UI');
    });
    $('#promiseBtn').addEventListener('click', () => {
      Promise.reject(new Error('Intentional unhandled promise rejection'));
    });
    $('#handledBtn').addEventListener('click', () => {
      try {
        JSON.parse('{ invalid json');
      } catch (e) {
        log('handled', e.message);
      }
    });

    // Global error listeners (helps visibility)
    window.addEventListener('error', (e) => log('window.error', e.message));
    window.addEventListener('unhandledrejection', (e) => log('window.unhandledrejection', e.reason?.message || String(e.reason)));
  </script>
  <!-- Runtime config override, if present -->
  <script src="/config.js"></script>
</body>
</html>
```

---

### 2) `config.js` (runtime override)

> In GKE weâ€™ll mount this via ConfigMap at `/usr/share/nginx/html/config.js` so you can change API targets without rebuilding.

```js
window.__CONFIG__ = {
  // e.g., behind GKE Ingress path-based routing
  // BASE_URL: "/order-api"
  // or direct service external IP / domain
  BASE_URL: "https://your-order-api.example.com"
};
```

---

### 3) `Dockerfile`

```dockerfile
FROM nginx:1.27-alpine

# Copy app
COPY index.html /usr/share/nginx/html/index.html
# config.js is provided at runtime by a ConfigMap (optional). If not present, index.html default is used.
# You can also bake a default here if you want:
# COPY config.js /usr/share/nginx/html/config.js

# Basic hardening + gzip
RUN sed -i 's/sendfile\s\s*on;/sendfile off;/' /etc/nginx/nginx.conf \
    && printf '\nhttp { include /etc/nginx/mime.types; }\n' >> /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx","-g","daemon off;"]
```

---

### 4) `k8s.yaml` (ConfigMap + Deployment + Service + optional Ingress)

> Replace `NAMESPACE`, `YOUR_DOMAIN`, and adjust replica count / resources as needed.

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: NAMESPACE
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: order-ui-config
  namespace: NAMESPACE
  labels:
    app: order-ui
  annotations:
    # Edit BASE_URL here and apply without rebuild
    purpose: "runtime-config for order-ui"
data:
  config.js: |
    window.__CONFIG__ = {
      // Ingress path or full URL for your order service
      // BASE_URL: "/order-api"
      BASE_URL: "https://your-order-api.example.com"
    };
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-ui
  namespace: NAMESPACE
  labels:
    app: order-ui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: order-ui
  template:
    metadata:
      labels:
        app: order-ui
    spec:
      containers:
        - name: web
          image: your-registry/order-ui:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
          volumeMounts:
            - name: runtime-config
              mountPath: /usr/share/nginx/html/config.js
              subPath: config.js
              readOnly: true
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 2
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: runtime-config
          configMap:
            name: order-ui-config
            items:
              - key: config.js
                path: config.js
---
apiVersion: v1
kind: Service
metadata:
  name: order-ui
  namespace: NAMESPACE
  labels:
    app: order-ui
spec:
  selector:
    app: order-ui
  ports:
    - name: http
      port: 80
      targetPort: 80
  type: LoadBalancer # simplest; you may switch to ClusterIP if using Ingress
---
# Optional: GKE Ingress (path-based), if you have an Ingress controller set up
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: order-ui
  namespace: NAMESPACE
  annotations:
    kubernetes.io/ingress.class: "gce"  # or your ingress class
spec:
  rules:
    - host: YOUR_DOMAIN
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: order-ui
                port:
                  number: 80
```

---

## ğŸš€ Build & Deploy

```bash
# 1) Build & push
REG=YOUR_REGISTRY
IMAGE=$REG/order-ui:0.1.0

docker build -t $IMAGE .
docker push $IMAGE

# 2) Apply manifests
kubectl apply -f k8s.yaml

# 3) (Optional) Update BASE_URL at runtime
kubectl -n NAMESPACE edit configmap order-ui-config
# then rollout restart to pick up new config.js (volume refresh)
kubectl -n NAMESPACE rollout restart deploy/order-ui

# 4) Get access
kubectl -n NAMESPACE get svc order-ui
# or, if using Ingress, browse http(s)://YOUR_DOMAIN/
```

---

## ğŸ”Œ Hooking to your Order API

* **GET** `${BASE_URL}/orders/{id}` â†’ ì¡°íšŒ ë²„íŠ¼ì´ í˜¸ì¶œí•©ë‹ˆë‹¤.
* **POST** `${BASE_URL}/orders` with JSON body â†’ ì „ì†¡ ë²„íŠ¼ì´ í˜¸ì¶œí•©ë‹ˆë‹¤.
* **GET** `${BASE_URL}/health` â†’ í—¬ìŠ¤ ì²´í¬ ë²„íŠ¼.

> GKE Ingressë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ë°±ì—”ë“œ(ì£¼ë¬¸ ì„œë¹„ìŠ¤)ë¥¼ `/order-api` ê°™ì€ ê²½ë¡œë¡œ ë…¸ì¶œí•˜ê³ , `config.js`ì˜ `BASE_URL`ë§Œ ê·¸ ê²½ë¡œë¡œ ë§ì¶”ë©´ ë©ë‹ˆë‹¤. (ì˜ˆ: `BASE_URL: "/order-api"`)

---

## ğŸ§ª JS Error í…ŒìŠ¤íŠ¸

* **Unhandled**: `throw new Error(...)` ë²„íŠ¼ ë° Promise rejection ë²„íŠ¼.
* **Handled**: try/catchë¡œ ì¡ê³  í™”ë©´ ë¡œê·¸ì—ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
* `window.onerror` / `unhandledrejection` ë¦¬ìŠ¤ë„ˆê°€ ìˆì–´ Instana EUM ë“±ì˜ ìˆ˜ì§‘ê¸°ì—ì„œ ì˜ ë³´ì´ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## â• Variants (ì„ íƒ)

* ì¸ì¦ í† í°ì´ í•„ìš”í•˜ë©´ `fetch` í˜¸ì¶œì— `Authorization: Bearer <token>` í—¤ë”ë¥¼ ì¶”ê°€í•˜
